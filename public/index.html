<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Records</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>

<body class="bg-gradient-to-br from-indigo-100 via-blue-50 to-purple-100 min-h-screen p-8">

    <div class="max-w-7xl mx-auto bg-white shadow-2xl rounded-3xl p-8">

        <!-- Header Section -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">üéì Student Records</h1>

            <div class="flex gap-4">
                <button onclick="openAddModal()"
                    class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-xl shadow-lg transition">
                    + Add Student
                </button>

                <button onclick="handleLogout()"
                    class="bg-red-700 hover:bg-red-600 text-white px-4 py-2 rounded-xl shadow-lg transition">
                    LOGOUT
                </button>
            </div>
        </div>

        <!-- Search Section -->
        <div class="mb-6">
            <input type="text" id="searchInput" placeholder="üîç Search by name..."
                class="w-1/2 px-5 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-400 focus:outline-none shadow-sm">
        </div>

        <!-- Table Section -->
        <div class="overflow-x-auto rounded-2xl shadow-lg">
            <table class="min-w-full text-left">
                <thead class="bg-gray-900 text-white">
                    <tr>
                        <th class="py-4 px-4">Profile</th>
                        <th class="py-4 px-4">First Name</th>
                        <th class="py-4 px-4">Last Name</th>
                        <th class="py-4 px-4">Email</th>
                        <th class="py-4 px-4">Phone</th>
                        <th class="py-4 px-4">Gender</th>
                        <th class="py-4 px-4 text-center">Actions</th>
                    </tr>
                </thead>

                <tbody class="divide-y divide-gray-200 bg-white" id="studentTableBody"></tbody>
            </table>
            
        </div>
        <nav class="pt-10">
            <ul class="flex justify-center text-xs font-medium space-x-1" id="pagination"></ul>
        </nav>
    </div>

    <!-- ================= VIEW MODAL ================= -->
    <div id="viewModal" class="fixed inset-0 bg-black bg-opacity-40 hidden justify-center items-center">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl p-8 relative">
            <div class="flex flex-col items-center">
                <div id="viewprofilepic" class="w-auto h-15 rounded-full object-cover border-1 border-black shadow-xl">
                </div>
                <h2 class="text-2xl font-bold text-gray-800" id="viewname"></h2>
                <p class="text-gray-500 mb-6">Student Profile</p>
            </div>
            <div class="space-y-4">
                <div class="flex justify-between border-b pb-2">
                    <span class="text-gray-600 font-medium">Email</span>
                    <span class="text-blue-600" id="viewemail"></span>
                </div>
                <div class="flex justify-between border-b pb-2">
                    <span class="text-gray-600 font-medium">Phone</span>
                    <span class="text-gray-700" id="viewphone"></span>
                </div>
                <div class="flex justify-between border-b pb-2">
                    <span class="text-gray-600 font-medium">Gender</span>
                    <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm" id="viewgender"></span>
                </div>
            </div>

            <!-- Close Button -->
            <button onclick="closeStudent()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-xl">
                ‚úñ
            </button>

            <div id="viewaStudent"></div>
            <!-- Action Buttons -->
            <div class="flex justify-center mt-6">
                <button onclick="closeStudent()"
                    class="bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-2 rounded-xl shadow-md">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- ================= EDIT MODAL ================= -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-40 hidden justify-center items-center">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-8 relative">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">‚úè Edit Student</h2>

            <form id="editForm" class="space-y-4">
                <!-- Hidden ID for update -->
                <input type="hidden" id="editId">

                <!-- Profile Image Preview (for edit, if needed) -->
                <div class="flex flex-col items-center">
                    <div class="p-1 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full">
                        <img id="editPreviewImage" src=""
                            class="w-24 h-24 rounded-full object-cover border-4 border-white shadow-lg">
                    </div>
                    <input type="file" accept="image/*" onchange="previewEditProfile(event)" class="mt-3 text-sm">
                </div>

                <div>
                    <label class="block text-gray-600 mb-1">First Name</label>
                    <input type="text" id="editFirstName"
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 focus:outline-none">
                </div>

                <div>
                    <label class="block text-gray-600 mb-1">Last Name</label>
                    <input type="text" id="editLastName"
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 focus:outline-none">
                </div>

                <div>
                    <label class="block text-gray-600 mb-1">Email</label>
                    <input type="email" id="editEmail"
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 focus:outline-none">
                </div>

                <div>
                    <label class="block text-gray-600 mb-1">Phone</label>
                    <input type="text" id="editPhone"
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 focus:outline-none">
                </div>

                <div>
                    <label class="block text-gray-600 mb-1">Gender</label>
                    <select id="editGender"
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 focus:outline-none">
                        <option>Male</option>
                        <option>Female</option>
                    </select>
                </div>

                <!-- Buttons -->
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" onclick="closeUpdateStudent()"
                        class="bg-gray-400 hover:bg-gray-500 text-white px-5 py-2 rounded-lg">
                        Cancel
                    </button>

                    <button type="submit" class="bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-2 rounded-lg">
                        Save Changes
                    </button>
                </div>
            </form>

            <!-- Close Icon -->
            <button onclick="closeUpdateStudent()"
                class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-xl">
                ‚úñ
            </button>
        </div>
    </div>

    <!-- ================= ADD STUDENT MODAL ================= -->
    <div id="addModal" class="fixed inset-0 bg-black bg-opacity-40 hidden justify-center items-center">
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl p-8 relative">
            <!-- Close Button -->
            <button onclick="closeAddModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-xl">
                ‚úñ
            </button>

            <h2 class="text-2xl font-bold text-gray-800 mb-6">‚ûï Add New Student</h2>

            <form id="addForm" class="space-y-4">
                <!-- Profile Image -->
                <div class="flex flex-col items-center">
                    <div class="p-1 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full">
                        <img id="previewImage" src=""
                            class="w-24 h-24 rounded-full object-cover border-4 border-white shadow-lg">
                    </div>

                    <input type="file" accept="image/*" onchange="previewProfile(event)" class="mt-3 text-sm">
                </div>

                <div>
                    <label class="block text-gray-600 mb-1">First Name</label>
                    <input type="text" id="addFirstName"
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 focus:outline-none"
                        placeholder="Enter first name" required>
                </div>

                <div>
                    <label class="block text-gray-600 mb-1">Last Name</label>
                    <input type="text" id="addLastName"
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 focus:outline-none"
                        placeholder="Enter last name" required>
                </div>

                <div>
                    <label class="block text-gray-600 mb-1">Email</label>
                    <input type="email" id="addEmail"
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 focus:outline-none"
                        placeholder="Enter email" required>
                </div>

                <div>
                    <label class="block text-gray-600 mb-1">Phone</label>
                    <input type="text" id="addPhone"
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 focus:outline-none"
                        placeholder="Enter phone number" required>
                </div>

                <div>
                    <label class="block text-gray-600 mb-1">Gender</label>
                    <select id="addGender"
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 focus:outline-none"
                        required>
                        <option>Select Gender</option>
                        <option>Male</option>
                        <option>Female</option>
                    </select>
                </div>

                <!-- Buttons -->
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" onclick="closeAddModal()"
                        class="bg-gray-400 hover:bg-gray-500 text-white px-5 py-2 rounded-lg">
                        Cancel
                    </button>

                    <button type="submit"
                        class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg shadow">
                        Save Student
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ================= SCRIPT ================= -->
    <script>
        const apiUrl = 'https://basic-api-lemon.vercel.app/api/students/';
        
        let currentPage = 1;
        let currentSearch= '';

        function checkAuth(){
            const token= localStorage.getItem('token');
            if(!token){
                window.location.href='login';
            }
            return token;
        }

        function handleLogout(){
            localStorage.removeItem('token');
            checkAuth();
        }
        const token = checkAuth();
        // Open Add Modal
        function openAddModal() {
            document.getElementById('addModal').classList.remove('hidden');
            document.getElementById('addModal').classList.add('flex');
        }

        // Close Add Modal
        function closeAddModal() {
            document.getElementById('addModal').classList.add('hidden');
            document.getElementById('addModal').classList.remove('flex');
            // Reset form
            document.getElementById('addForm').reset();
            document.getElementById('previewImage').src = 'https://via.placeholder.com/150';
        }

        // Profile Image Preview for Add Modal
        function previewProfile(event) {
            const reader = new FileReader();
            reader.onload = function () {
                document.getElementById('previewImage').src = reader.result;
            };
            reader.readAsDataURL(event.target.files[0]);
        }

        // Profile Image Preview for Edit Modal
        function previewEditProfile(event) {
            const reader = new FileReader();
            reader.onload = function () {
                document.getElementById('editPreviewImage').src = reader.result;
            };
            reader.readAsDataURL(event.target.files[0]);
        }

        // Close View Modal
        function closeStudent() {
            document.getElementById('viewModal').classList.add('hidden');
            document.getElementById('viewModal').classList.remove('flex');
        }

        // Close Edit Modal
        function closeUpdateStudent() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
        }

        // Fetch and Display Students
        async function fetchStudents(search = '', page=1) {
            currentPage = page;
            currentSearch = search;
            try {
                const result = await fetch(`${apiUrl}?search=${encodeURIComponent(search)}&page=${page}&limit=3`,{
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                });
                const data = await result.json();
                const tbody = document.querySelector('#studentTableBody');
                tbody.innerHTML = '';
                data.students.forEach(student => {
                    const profilePic = (student.profile_pic)
                        ? `<img src="http://localhost:3000/uploads/${student.profile_pic}" alt="Profile Pic" class="w-10 h-10 rounded-full object-cover border border-gray-300 shadow-sm"/>`
                        : `<div class="w-10 h-10 bg-indigo-500 text-white flex items-center justify-center rounded-full font-bold">${student.first_name[0]}</div>`;
                    tbody.innerHTML += `<tr class="hover:bg-gray-50 transition">
                        <td class="py-3 px-4">${profilePic}</td>
                        <td class="py-3 px-4 font-medium">${student.first_name}</td>
                        <td class="py-3 px-4">${student.last_name}</td>
                        <td class="py-3 px-4 text-blue-600">${student.email}</td>
                        <td class="py-3 px-4">${student.phone}</td>
                        <td class="py-3 px-4">
                            <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm">
                                ${student.gender}
                            </span>
                        </td>
                        <td class="py-3 px-4 text-center">
                            <div class="flex justify-center gap-2">
                                <button onclick="viewStudent('${student._id}')" class="bg-cyan-500 hover:bg-cyan-600 text-white px-3 py-1 rounded-lg text-sm">
                                    View
                                </button>
                                <button onclick="UpdateStudent('${student._id}')"
                                    class="bg-yellow-400 hover:bg-yellow-500 text-white px-3 py-1 rounded-lg text-sm">
                                    Edit
                                </button>
                                <button onclick="deleteStudent('${student._id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm">
                                    Delete
                                </button>
                            </div>
                        </td>
                    </tr>`;
                });
                renderPagination(data.totalPage);
            } catch (error) {
                console.error('Error fetching students:', error);
            }
        }

        // Initial Load
        fetchStudents();

        function renderPagination(totalPages){
            const container =document.querySelector('#pagination');
            container.innerHTML='';

            const prevli = document.createElement('li');
            prevli.className = 'rounded-md shadow-md ' + (currentPage===1 ? 'pointer-events-none opacity-50 cursor-not-allowed' : 'hover:bg-gray-300');
            prevli.innerHTML=`<a class="block px-2 h-8 text-center border border-gray-100 leading-8" href="#"> Previous </a>`;
            prevli.addEventListener("click", (e)=>{
                e.preventDefault();
                fetchStudents(currentSearch, currentPage-1);
            })
            container.appendChild(prevli);
            
            for(let i=1;i<=totalPages;i++){
                const li=document.createElement('li');
                li.className = 'rounded-md shadow-md ' + (i===currentPage ? 'bg-blue-600 text-white' : 'hover:bg-gray-300');
                li.innerHTML=`<a class="block w-8 h-8 text-center border border-gray-100 leading-8" href="#">${i}</a>`;
                li.addEventListener("click", (e)=>{
                    e.preventDefault();
                    fetchStudents(currentSearch, i);
                })
                container.appendChild(li);
            }

            const nextli = document.createElement('li');
            nextli.className = 'rounded-md shadow-md ' + (currentPage===totalPages ? 'pointer-events-none opacity-50 cursor-not-allowed' : 'hover:bg-gray-300');
            nextli.innerHTML=`<a class="block px-2 h-8 text-center border border-gray-100 leading-8" href="#"> Next </a>`;
            nextli.addEventListener("click", (e)=>{
                e.preventDefault();
                fetchStudents(currentSearch, currentPage+1);
            })
            container.appendChild(nextli);
        }

        // Search Functionality
        document.querySelector('#searchInput').addEventListener("input", () => {
            currentPage=1;
            fetchStudents(document.querySelector('#searchInput').value);
        });

        // View Student Details
        async function viewStudent(id) {
            try {
                const result = await fetch(apiUrl + id, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                });
                const data = await result.json();
                document.querySelector('#viewprofilepic').innerHTML = (data.profile_pic)
                    ? `<img src="http://localhost:3000/uploads/${data.profile_pic}" alt="Profile Pic" class="w-20 h-20 rounded-full object-cover"/>`
                    : `<div class="w-20 h-20 bg-indigo-500 text-white flex items-center justify-center rounded-full font-bold text-xl">${data.first_name[0]}</div>`;
                document.querySelector('#viewname').innerHTML = data.first_name + ' ' + data.last_name;
                document.querySelector('#viewemail').innerHTML = data.email;
                document.querySelector('#viewphone').innerHTML = data.phone;
                document.querySelector('#viewgender').innerHTML = data.gender;
                document.getElementById('viewModal').classList.remove('hidden');
                document.getElementById('viewModal').classList.add('flex');
            } catch (error) {
                console.error('Error viewing student:', error);
            }
        }

        // Open Edit Modal and Populate Data
        async function UpdateStudent(id) {
            try {
                const result = await fetch(apiUrl + id,{
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                });
                const data = await result.json();
                document.getElementById('editId').value = data._id;
                document.getElementById('editFirstName').value = data.first_name;
                document.getElementById('editLastName').value = data.last_name;
                document.getElementById('editEmail').value = data.email;
                document.getElementById('editPhone').value = data.phone;
                document.getElementById('editGender').value = data.gender;
                document.getElementById('editPreviewImage').src = (data.profile_pic)
                    ? `http://localhost:3000/uploads/${data.profile_pic}`
                    : 'https://via.placeholder.com/150';
                document.getElementById('editModal').classList.remove('hidden');
                document.getElementById('editModal').classList.add('flex');
            } catch (error) {
                console.error('Error loading student for edit:', error);
            }
        }

        // Handle Edit Form Submission
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const formData = new FormData();
            formData.append('first_name', document.getElementById('editFirstName').value);
            formData.append('last_name', document.getElementById('editLastName').value);
            formData.append('email', document.getElementById('editEmail').value);
            formData.append('phone', document.getElementById('editPhone').value);
            formData.append('gender', document.getElementById('editGender').value);
            // Add image if changed (assuming file input is for updating profile pic)
            const fileInput = document.querySelector('#editModal input[type="file"]');
            if (fileInput.files[0]) {
                formData.append('profile_pic', fileInput.files[0]);
            }

            try {
                const response = await fetch(apiUrl + id, {
                    method: 'PUT',
                    body: formData,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                });
                if (response.ok) {
                    alert('Student updated successfully!');
                    closeUpdateStudent();
                    fetchStudents(); // Refresh the list
                } else {
                    alert('Error updating student.');
                }
            } catch (error) {
                console.error('Error updating student:', error);
                alert('Error updating student.');
            }
        });

        // Delete Student
        async function deleteStudent(id) {
            if (confirm('Are you sure you want to delete this student?')) {
                try {
                    const response = await fetch(apiUrl + id, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`,
                        },
                    });
                    if (response.ok) {
                        alert('Student deleted successfully!');
                        fetchStudents(); // Refresh the list
                    } else {
                        alert('Error deleting student.');
                    }
                } catch (error) {
                    console.error('Error deleting student:', error);
                    alert('Error deleting student.');
                }
            }
        }

        // Handle Add Form Submission
        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('first_name', document.getElementById('addFirstName').value);
            formData.append('last_name', document.getElementById('addLastName').value);
            formData.append('email', document.getElementById('addEmail').value);
            formData.append('phone', document.getElementById('addPhone').value);
            formData.append('gender', document.getElementById('addGender').value);
            // Add profile image
            const fileInput = document.querySelector('#addModal input[type="file"]');
            if (fileInput.files[0]) {
                formData.append('profile_pic', fileInput.files[0]);
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                });
                if (response.ok) {
                    alert('Student added successfully!');
                    closeAddModal();
                    fetchStudents(); // Refresh the list
                } else {
                    alert('Error adding student.');
                }
            } catch (error) {
                console.error('Error adding student:', error);
                alert('Error adding student.');
            }
        });
    </script>
</body>

</html>
